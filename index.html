<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Heart Beat</title>

  <style>
    body {
      overflow: hidden;
      margin: 0;
      font-family: "Russo One", arial, sans-serif;
    }

    .type_words {
      position: fixed;
      bottom: 5%;
      left: 50%;
      transform: translateX(-50%);
      width: 180px;
      height: 180px;
      color: #f1dadb;
      padding: 20px;
      text-transform: lowercase;
    }
    #canvas{
      position: fixed;
      top: 0;
      left: 0;
      /* right: 0;
      bottom: 0; */
    }
  </style>
</head>

<body>
  <audio id="audioDom" src="https://sf6-cdn-tos.douyinstatic.com/obj/ies-music/7170534431801838367.mp3" preload="auto"
    loop="loop"></audio>
  <div class="type_words" id="contents"></div>
  <script src="js/three.min.js"></script>
  <script src="./js/script.min.js"></script>
  <script src="js/script.js"></script>
  <script>
    function musicPlay(isPlay) {
      var media = document.querySelector('#audioDom');
      if (isPlay && media.paused) {
        media.play();
      }
      if (!isPlay && !media.paused) {
        media.pause();
      }
    }
    function musicInBrowserHandler() {
      setTimeout(function () {
        musicPlay(true)
      }, 0)
    }
    document.body.addEventListener('touchstart', musicInBrowserHandler);
    document.body.addEventListener('click', musicInBrowserHandler);

    function start() {
      const text = [
        "于我而言，你是最好且是唯一❤️",
        "宝贝，永远爱你❤️"
      ]
      let str = text.join('<br><br>')
      let str_ = ''
      let i = 0
      let content = document.getElementById('contents')
      let timer = setInterval(() => {
        if (str_.length < str.length) {
          str_ += str[i++]
          content.innerHTML = '<p>' + str_ + '<span class="xx" style="opacity: 1;    color: red;">❤</span></p>'                        //打印时加光标
        } else {
          clearInterval(timer)
          content.innerHTML = '<p>' + str_ + '</p>'
        }
      }, 100)
    }
    setTimeout(() => {
      start();
    }, 1000);
  </script>

  <canvas id="canvas"></canvas>
  <script>
    const cos = Math.cos;
    const sin = Math.sin;
    const PI = Math.PI;
    let sideNum = 4;  // 雪花形状（正N边形）
    let snowCount = 200;  // 雪花总数量
    let _WIDTH = window.innerWidth;  // 设备窗口宽度
    let _HEIGHT = window.innerHeight;  // 设备窗口高度
    let snowSize = [1, 3]; // 雪花的大小范围
    let threshold = 4;  // 显示第三层棱角的阈值
    let speed = [0.5, 1];  // 雪花的速度
    let space = ~~(_HEIGHT / ((speed[0] + speed[1]) / 2) * 16.6 / snowCount);  // 雪花出现时间间隔
    let snows = [];  // 存放雪花的数组
    let snow;  // 单个雪花
    let timeouts = []; // 雪花的定时器数组
    let canvas;
    let ctx;

    window.addEventListener('resize', () => {
      initCanvas();
      drawSnows();
    });
    window.onload = function () {
      initCanvas();
      drawSnows();
      move();
    }

    const Snow = function () { };
    Snow.prototype = {
      init(x = random(0, _WIDTH), y = 0) {
        this.x = x;
        this.y = y;
        this.r = random(...snowSize);
        this._x = random(0.2, 2);
        this._y = random(...speed);
        this.rotateSpeed = this._y / 2;
        this.angle = 0;
      },
      draw() {
        // ctx.drawImage(this.snowCanvas, this.x, this.y)
        ctx.save()
        ctx.translate(this.x + this.snowCanvas.width / 2, this.y + this.snowCanvas.height / 2)
        ctx.rotate(this.angle % 360 * PI / 180)
        ctx.drawImage(this.snowCanvas, -this.snowCanvas.width / 2, -this.snowCanvas.height / 2);
        ctx.restore()
        this.update();
      },
      update() {
        if (this.y < _HEIGHT - this.r) {
          this.y += this._y;
          if (this.x < _WIDTH - this.r) {
            this.x += this._x;
          } else {
            this.init(0, this.y);
          }
        } else {
          this.init();
        }
        this.angle += this.rotateSpeed;
      }
    };

    function initCanvas() {
      _WIDTH = document.documentElement.clientWidth;
      _HEIGHT = document.documentElement.clientHeight;
      canvas = document.getElementById('canvas');
      canvas.setAttribute('width', _WIDTH);
      canvas.setAttribute('height', _HEIGHT);
      ctx = canvas.getContext('2d');
    }

    function drawSnows() {
      snows = snows.slice(0, snowCount);
      timeouts = [];
      for (let i = snows.length; i < snowCount; i += 1) {
        let timeout = setTimeout(function () {
          const snow = new Snow();
          snow.init();
          snow.snowCanvas = drawCanvas(snow.r);
          snows.push(snow);
        }, space * i);
        timeouts.push(timeout);
      }
    }

    function drawCanvas(size) {
      let coord = [[2 * size, 2 * size]];
      const canvasSnow = document.createElement('canvas');
      canvasSnow.setAttribute('width', coord[0][0] + size * 2);
      canvasSnow.setAttribute('height', coord[0][1] + size * 2);
      const ctxSnow = canvasSnow.getContext('2d');

      ctxSnow.save();
      ctxSnow.strokeStyle = '#FFFFFF';
      ctxSnow.lineWidth = 2;
      let coords = drawSnow(ctxSnow, coord, size);
      ctxSnow.lineWidth = 1;
      coords = drawSnow(ctxSnow, coords, size / 2.5);
      size > threshold && drawSnow(ctxSnow, coords, size / 6);
      ctxSnow.restore();
      return canvasSnow;
    }

    function drawSnow(ctxSnow, coord, size) {
      const coords = [];
      for (let i = 0, length = coord.length; i < length; i += 1) {
        for (let j = 0; j < sideNum; j += 1) {
          const { x2, y2 } = drawSide(ctxSnow, coord[i][0], coord[i][1], size, 2 * PI * (j / sideNum));
          coords.push([x2, y2]);
        }
      }
      return coords;
    }

    function drawSide(ctxSnow, x, y, size, radian) {
      const x2 = size * cos(radian) + x;
      const y2 = size * sin(radian) + y;
      drawLine(ctxSnow, x, y, x2, y2);
      return { x2, y2 };
    }

    function drawLine(ctxSnow, x1, y1, x2, y2) {
      ctxSnow.beginPath();
      ctxSnow.lineTo(x1, y1);
      ctxSnow.lineTo(x2, y2);
      ctxSnow.stroke();
    }

    function move() {
      ctx.clearRect(0, 0, _WIDTH, _HEIGHT);
      let length = snows.length;
      for (let i = 0; i < length; i++) {
        snows[i].draw();
      }
      requestAnimationFrame(move);
    }

    function random(min, max) {
      return Math.random() * (max - min) + min;
    }
  </script>
</body>

</html>